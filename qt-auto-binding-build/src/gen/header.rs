use qt_auto_binding_core::Object;
use std::{
    fs::File,
    io::{Result as IoResult, Write},
    path::Path,
};

fn gen_declaration(object: &Object) -> String {
    #[cfg_attr(rustfmt, rustfmt_skip)]
        format!(
r#"class {name}: public QObject
{{
    Q_OBJECT
public:
    Q_INVOKABLE explicit {name}(QObject *parent = 0);
    ~{name}();
private:
    void *m_data;
}};"#,
            name = object.name()
        )
}

fn gen_meta_type(object: &Object) -> String {
    format!("Q_DECLARE_METATYPE(qt_auto_binding::{}*)", object.name())
}

fn perform_gen(file_path: &Path, objects: &[Object]) -> IoResult<()> {
    let declarations = objects
        .into_iter()
        .map(gen_declaration)
        .collect::<Vec<_>>()
        .join("\n\n");

    let meta_types = objects
        .into_iter()
        .map(gen_meta_type)
        .collect::<Vec<_>>()
        .join("\n");

    #[cfg_attr(rustfmt, rustfmt_skip)]
    let content = format!(
r#"// This file has been generated by qt_binding
//
// Any modification will be discarded.

#ifndef AUTOGENERATED_BY_QTBINDING_BINDINGS_H
#define AUTOGENERATED_BY_QTBINDING_BINDINGS_H

#include <QtCore/QObject>
#include <QtCore/QMetaType>

namespace qt_auto_binding {{

{}

}} // namespace qt_auto_binding

{}

#endif // AUTOGENERATED_BY_QTBINDING_BINDINGS_H
"#,
        declarations,
        meta_types
    );

    let mut file = File::create(file_path)?;
    file.write_all(content.as_bytes())?;

    Ok(())
}

pub(crate) fn gen(file_path: &Path, objects: &[Object]) {
    perform_gen(file_path, objects).unwrap()
}
